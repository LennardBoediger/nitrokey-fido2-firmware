// Copyright 2019 SoloKeys Developers
//
// Licensed under the Apache License, Version 2.0, <LICENSE-APACHE or
// http://apache.org/licenses/LICENSE-2.0> or the MIT license <LICENSE-MIT or
// http://opensource.org/licenses/MIT>, at your option. This file may not be
// copied, modified, or distributed except according to those terms.
#include <stdint.h>
#include <string.h>
#include "crypto.h"
#include "memory_layout.h"
#include "device.h"
#include "sense.h"
#include "log.h"

const uint8_t attestation_solo_cert_der[] =
"\x30\x82\x02\x72\x30\x82\x02\x18\xa0\x03\x02\x01\x02\x02\x01\x01\x30\x0a\x06\x08"
"\x2a\x86\x48\xce\x3d\x04\x03\x02\x30\x4e\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13"
"\x02\x44\x45\x31\x16\x30\x14\x06\x03\x55\x04\x0a\x0c\x0d\x4e\x69\x74\x72\x6f\x6b"
"\x65\x79\x20\x47\x6d\x62\x48\x31\x10\x30\x0e\x06\x03\x55\x04\x0b\x0c\x07\x52\x6f"
"\x6f\x74\x20\x43\x41\x31\x15\x30\x13\x06\x03\x55\x04\x03\x0c\x0c\x6e\x69\x74\x72"
"\x6f\x6b\x65\x79\x2e\x63\x6f\x6d\x30\x20\x17\x0d\x32\x30\x30\x35\x30\x38\x30\x39"
"\x33\x35\x33\x35\x5a\x18\x0f\x32\x30\x37\x30\x30\x34\x32\x36\x30\x39\x33\x35\x33"
"\x35\x5a\x30\x60\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x44\x45\x31\x16\x30"
"\x14\x06\x03\x55\x04\x0a\x0c\x0d\x4e\x69\x74\x72\x6f\x6b\x65\x79\x20\x47\x6d\x62"
"\x48\x31\x22\x30\x20\x06\x03\x55\x04\x0b\x0c\x19\x41\x75\x74\x68\x65\x6e\x74\x69"
"\x63\x61\x74\x6f\x72\x20\x41\x74\x74\x65\x73\x74\x61\x74\x69\x6f\x6e\x31\x15\x30"
"\x13\x06\x03\x55\x04\x03\x0c\x0c\x6e\x69\x74\x72\x6f\x6b\x65\x79\x2e\x63\x6f\x6d"
"\x30\x59\x30\x13\x06\x07\x2a\x86\x48\xce\x3d\x02\x01\x06\x08\x2a\x86\x48\xce\x3d"
"\x03\x01\x07\x03\x42\x00\x04\xb6\xa8\x02\x1d\x09\xdd\x48\x8f\x31\xdb\xe3\x7e\x26"
"\xd6\xcd\xa5\x44\x11\xc3\x34\x27\x93\x20\x6e\x51\x0a\x0c\x7f\x2c\xc8\x87\xb9\xa7"
"\x3c\x4a\xb4\x64\x2a\xb7\x8c\xa1\xd8\xc3\x80\x9f\x71\x2c\xc2\x9a\x73\x5d\xef\x2d"
"\xa4\x66\x25\xa0\x3a\xcf\x49\x6b\xd2\x02\x87\xa3\x81\xd2\x30\x81\xcf\x30\x1d\x06"
"\x03\x55\x1d\x0e\x04\x16\x04\x14\x2e\x5b\x45\x7e\x56\x10\xb4\xe5\xdd\xb4\xa9\x28"
"\x0b\xd1\x1f\xe8\xfe\xe5\xc6\x46\x30\x73\x06\x03\x55\x1d\x23\x04\x6c\x30\x6a\xa1"
"\x52\xa4\x50\x30\x4e\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x44\x45\x31\x16"
"\x30\x14\x06\x03\x55\x04\x0a\x0c\x0d\x4e\x69\x74\x72\x6f\x6b\x65\x79\x20\x47\x6d"
"\x62\x48\x31\x10\x30\x0e\x06\x03\x55\x04\x0b\x0c\x07\x52\x6f\x6f\x74\x20\x43\x41"
"\x31\x15\x30\x13\x06\x03\x55\x04\x03\x0c\x0c\x6e\x69\x74\x72\x6f\x6b\x65\x79\x2e"
"\x63\x6f\x6d\x82\x14\x16\x62\x04\x96\xe9\xd9\xf4\xff\x2d\xa4\x49\xf1\x7c\x25\xf6"
"\xa8\x57\xeb\x66\xe8\x30\x09\x06\x03\x55\x1d\x13\x04\x02\x30\x00\x30\x0b\x06\x03"
"\x55\x1d\x0f\x04\x04\x03\x02\x04\xf0\x30\x21\x06\x0b\x2b\x06\x01\x04\x01\x82\xe5"
"\x1c\x01\x01\x04\x04\x12\x04\x10\xc3\x9e\xfb\xa6\xfc\xf4\x4c\x3e\x82\x8b\xfc\x4a"
"\x61\x15\xa0\xff\x30\x0a\x06\x08\x2a\x86\x48\xce\x3d\x04\x03\x02\x03\x48\x00\x30"
"\x45\x02\x20\x24\x38\x71\x59\xc0\x8f\xe7\x9d\xef\xc3\xc8\xdc\x72\x6a\x82\xc2\x62"
"\x4b\xaf\x82\x6f\xb2\x74\x0b\x1c\x5f\x1f\x01\x0c\xbe\x4e\x54\x02\x21\x00\x9a\x9b"
"\x6d\x61\x4b\x84\x6f\x8d\xf7\xd6\x9a\x97\x96\x65\xe2\x8c\x4f\x58\x0c\x51\x01\x16"
"\xc6\xde\xab\x56\x83\x04\x5f\xd0\xbb\x1a"
;

const uint8_t attestation_hacker_cert_der[] =
"\x30\x82\x02\x72\x30\x82\x02\x18\xa0\x03\x02\x01\x02\x02\x01\x01\x30\x0a\x06\x08"
"\x2a\x86\x48\xce\x3d\x04\x03\x02\x30\x4e\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13"
"\x02\x44\x45\x31\x16\x30\x14\x06\x03\x55\x04\x0a\x0c\x0d\x4e\x69\x74\x72\x6f\x6b"
"\x65\x79\x20\x47\x6d\x62\x48\x31\x10\x30\x0e\x06\x03\x55\x04\x0b\x0c\x07\x52\x6f"
"\x6f\x74\x20\x43\x41\x31\x15\x30\x13\x06\x03\x55\x04\x03\x0c\x0c\x6e\x69\x74\x72"
"\x6f\x6b\x65\x79\x2e\x63\x6f\x6d\x30\x20\x17\x0d\x32\x30\x30\x35\x30\x38\x31\x32"
"\x30\x30\x30\x34\x5a\x18\x0f\x32\x30\x37\x30\x30\x34\x32\x36\x31\x32\x30\x30\x30"
"\x34\x5a\x30\x60\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x44\x45\x31\x16\x30"
"\x14\x06\x03\x55\x04\x0a\x0c\x0d\x4e\x69\x74\x72\x6f\x6b\x65\x79\x20\x47\x6d\x62"
"\x48\x31\x22\x30\x20\x06\x03\x55\x04\x0b\x0c\x19\x41\x75\x74\x68\x65\x6e\x74\x69"
"\x63\x61\x74\x6f\x72\x20\x41\x74\x74\x65\x73\x74\x61\x74\x69\x6f\x6e\x31\x15\x30"
"\x13\x06\x03\x55\x04\x03\x0c\x0c\x6e\x69\x74\x72\x6f\x6b\x65\x79\x2e\x63\x6f\x6d"
"\x30\x59\x30\x13\x06\x07\x2a\x86\x48\xce\x3d\x02\x01\x06\x08\x2a\x86\x48\xce\x3d"
"\x03\x01\x07\x03\x42\x00\x04\x7f\xbd\x8e\x19\x5e\x71\x19\xb8\x01\x3a\x34\xce\x3a"
"\xde\x05\x58\xad\xed\x50\xf1\xd3\xf3\x61\x21\xc0\x26\xa5\xc8\x6b\x1d\x67\x4b\x22"
"\x33\xae\x63\x1c\x93\xaa\x7f\xee\x13\x71\xd1\x53\x86\x59\xd1\xde\x34\xc2\x37\x94"
"\xbe\x14\xb6\x23\xb6\x5c\x86\x05\xc5\x78\x28\xa3\x81\xd2\x30\x81\xcf\x30\x1d\x06"
"\x03\x55\x1d\x0e\x04\x16\x04\x14\x1c\xd8\xff\xeb\x0b\xe1\xfd\x29\xfd\x5f\xb1\xb2"
"\x9c\x3e\xac\xa6\x79\xe6\x72\xf2\x30\x73\x06\x03\x55\x1d\x23\x04\x6c\x30\x6a\xa1"
"\x52\xa4\x50\x30\x4e\x31\x0b\x30\x09\x06\x03\x55\x04\x06\x13\x02\x44\x45\x31\x16"
"\x30\x14\x06\x03\x55\x04\x0a\x0c\x0d\x4e\x69\x74\x72\x6f\x6b\x65\x79\x20\x47\x6d"
"\x62\x48\x31\x10\x30\x0e\x06\x03\x55\x04\x0b\x0c\x07\x52\x6f\x6f\x74\x20\x43\x41"
"\x31\x15\x30\x13\x06\x03\x55\x04\x03\x0c\x0c\x6e\x69\x74\x72\x6f\x6b\x65\x79\x2e"
"\x63\x6f\x6d\x82\x14\x05\x13\xd6\xe6\xaf\x64\xd6\x91\xfc\x55\x67\x46\xd9\x0e\xc7"
"\xeb\x4a\x5e\xf6\xd7\x30\x09\x06\x03\x55\x1d\x13\x04\x02\x30\x00\x30\x0b\x06\x03"
"\x55\x1d\x0f\x04\x04\x03\x02\x04\xf0\x30\x21\x06\x0b\x2b\x06\x01\x04\x01\x82\xe5"
"\x1c\x01\x01\x04\x04\x12\x04\x10\xc3\x9e\xfb\xa6\xfc\xf4\x4c\x3e\x82\x8b\xfc\x4a"
"\x61\x15\xa0\xff\x30\x0a\x06\x08\x2a\x86\x48\xce\x3d\x04\x03\x02\x03\x48\x00\x30"
"\x45\x02\x21\x00\x9f\x85\x42\x74\xd3\xe1\x23\xbf\x15\xdb\xeb\x41\xb6\xe9\xdd\x43"
"\xa3\x44\x75\xd3\xdd\x26\x9c\xb2\xf6\x09\x00\xec\x75\x87\x28\xbc\x02\x20\x01\xb2"
"\xb1\x64\x12\x05\xff\xf7\x96\xc6\x44\xbb\x26\x14\x64\x05\x5a\x5e\xdd\x34\x02\x34"
"\xc5\x9f\x4e\x32\x36\xaf\xb0\xe4\x6c\x03"
;


const uint16_t attestation_solo_cert_der_size = sizeof(attestation_solo_cert_der)-1;
const uint16_t attestation_hacker_cert_der_size = sizeof(attestation_hacker_cert_der)-1;

uint8_t solo_hacker_attestation_key_old[32] = "\xfc\x02\x52\xbe\x0c\xb6\x80\xc0\x4c\xc3"
                                          "\x45\xb9\x2b\x2e\x47\xe0\x8c\xde\x36\x03"
                                          "\xdf\x53\x8c\xb0\xf9\x6f\xc3\xf2\x88\x50"
                                          "\x45\xf5";
uint8_t solo_hacker_attestation_key[32] =
    "\xdc\xc5\xce\x47\xac\xd6\x01\xa4\xab\x22\xe1\x30\x32\x42\x9d\xb1"
    "\xd5\x7c\xa1\x66\x9e\x40\xdb\xd7\x6a\x5d\xf4\x7d\x53\x6e\x86\x85";
// const uint16_t attestation_key_size = 32;
const uint8_t * attestation_cert_der = ((flash_attestation_page *)ATTESTATION_PAGE_ADDR)->attestation_cert;

uint8_t * device_get_attestation_key(){
    flash_attestation_page * page =(flash_attestation_page *)ATTESTATION_PAGE_ADDR;
    printf2(TAG_DUMP, "Getting attest key\n"); dump_arr(TAG_DUMP, page->attestation_key);
    return page->attestation_key;
}

uint16_t device_attestation_cert_der_get_size(){
    uint16_t sz = (uint16_t)((flash_attestation_page *)ATTESTATION_PAGE_ADDR)->attestation_cert_size;
    return sz;
}

void device_attestation_read_cert_der(uint8_t * dst){
    const uint8_t * der = ((flash_attestation_page *)ATTESTATION_PAGE_ADDR)->attestation_cert;
    uint16_t sz = device_attestation_cert_der_get_size();
    memmove(dst, der, sz);
    printf2(TAG_DUMP, "Getting attest cert [32 out of %d]\n", sz); dump_arrl(TAG_DUMP, dst, 32);
}

const uint8_t global_aaguid[16] = "\xc3\x9e\xfb\xa6\xfc\xf4\x4c\x3e\x82\x8b\xfc\x4a\x61\x15\xa0\xff";
